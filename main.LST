C51 COMPILER V9.02   MAIN                                                                  11/05/2020 23:56:57 PAGE 1   


C51 COMPILER V9.02, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE main.c ROM(COMPACT) BROWSE INCDIR(.\Hardware) DEBUG OBJECTEXTEND

line level    source

   1          #include <reg52.h>
   2          #include "KeyBoard.h"
   3          #include "LightGate.h"
   4          #include "TimeCounter.h"
   5          #include "LCD1602.h"
   6          #include "DigitalTube.h"
   7          
   8          #ifndef __U_8_16__
              #define __U_8_16__
              typedef unsigned char u8;
              typedef unsigned int u16;
              #endif
  13          
  14          #define PI 3.141592653589793
  15          
  16          sbit BUZZ = P1^6;
  17          
  18          u8 Total;
  19          double param_a_mm, param_b_mm, param_H_mm, param_M_g, param_g, Period;
  20          bit MeasureFlag = 0,    //测量完成标志
  21                  BuzzFlag = 0;   //蜂鸣器振荡标志
  22          
  23          void readParam();
  24          void showResult();
  25          void showTime();
  26          void delay(u8);
  27          u8 uftoa(char* , double, u8);
  28          
  29          void main()
  30          {
  31   1              readParam();
  32   1              InitDigitalTube();
  33   1              InitTimeCounter();
  34   1              InitLightGate();
  35   1              showTime();
  36   1              showResult();
  37   1              while(1);
  38   1      }
  39          
  40          void delay(u8 ms)
  41          {
  42   1              u8 i=ms<<1, j=113;
  43   1              do
  44   1              {
  45   2                      while (--j);
  46   2              } while (--i);
  47   1      }
  48          
  49          void readParam()
  50          {
  51   1              u8 state=0, key, len=2, max_len=10;
  52   1              unsigned char* tip_str;
  53   1              bit right_range=0;
  54   1              unsigned long num=10;
  55   1              InitLcd1602(1);
C51 COMPILER V9.02   MAIN                                                                  11/05/2020 23:56:57 PAGE 2   

  56   1              LcdShowStr(0,0,"NumberOfPeriods:");
  57   1              LcdShowStr(0,1,"10");
  58   1              while(1)
  59   1              {
  60   2                      if (key = readKey())
  61   2                      {
  62   3                              if (key >= '0' && key <= '9' && len < max_len && state<6)
  63   3                              {
  64   4                                      LcdWriteDat(key);
  65   4                                      ++len;
  66   4                                      num=num*10 + (key - '0');
  67   4                                      continue;
  68   4                              }
  69   3                              switch (key)
  70   3                              {
  71   4                              case ESC:
  72   4                                      if (len > 0)
  73   4                                      {
  74   5                                              --len;
  75   5                                              num/=10;
  76   5                                              LcdSetCursor(len, 1);
  77   5                                              LcdWriteDat(' ');
  78   5                                              LcdSetCursor(len, 1);
  79   5                                      }
  80   4                                      break;
  81   4                              case ENTER:
  82   4                                      right_range=0;
  83   4                                      switch (state)
  84   4                                      {
  85   5                                      case 0://输入周期数
  86   5                                              if (num<=99 && num>=1)
  87   5                                              {
  88   6                                                      right_range=1;
  89   6                                                      Total=num;
  90   6                                                      tip_str="100*a(mm):";
  91   6                                              }
  92   5                                              else
  93   5                                              {
  94   6                                                      tip_str="OutOfRange:1-99";
  95   6                                              }
  96   5                                              break;
  97   5                                      case 1://输入上圆盘悬线孔构成的三角形边长a
  98   5                                              if (num>=1)
  99   5                                              {
 100   6                                                      right_range=1;
 101   6                                                      param_a_mm=num/100.0;
 102   6                                                      tip_str="100*b(mm):";
 103   6                                              }
 104   5                                              else
 105   5                                              {
 106   6                                                      tip_str="OutOfRange:a>0";
 107   6                                              }
 108   5                                              break;
 109   5                                      case 2://输入下圆盘悬线孔构成的三角形边长b
 110   5                                              if (num>=1)
 111   5                                              {
 112   6                                                      right_range=1;
 113   6                                                      param_b_mm=num/100.0;
 114   6                                                      tip_str="100*H(mm):";
 115   6                                              }
 116   5                                              else
 117   5                                              {
C51 COMPILER V9.02   MAIN                                                                  11/05/2020 23:56:57 PAGE 3   

 118   6                                                      tip_str="OutOfRange:b>0";
 119   6                                              }
 120   5                                              break;
 121   5                                      case 3://输入上、下圆盘之间的距离H
 122   5                                              if (num>=1)
 123   5                                              {
 124   6                                                      right_range=1;
 125   6                                                      param_H_mm=num/100.0;
 126   6                                                      tip_str="100*M(g):";
 127   6                                              }
 128   5                                              else
 129   5                                              {
 130   6                                                      tip_str="OutOfRange:H>0";
 131   6                                              }
 132   5                                              break;
 133   5                                      case 4://输入被转动物体总质量M
 134   5                                              if (num>=1)
 135   5                                              {
 136   6                                                      right_range=1;
 137   6                                                      param_M_g=num/100.0;
 138   6                                                      tip_str="100*g(m/s2):";
 139   6                                              }
 140   5                                              else
 141   5                                              {
 142   6                                                      tip_str="OutOfRange:M>0";
 143   6                                              }
 144   5                                              break;
 145   5                                      case 5://输入重力加速度g
 146   5                                              if (num>=1)
 147   5                                              {
 148   6                                                      right_range=1;
 149   6                                                      param_g=num/100.0;
 150   6                                                      InitLcd1602(0);
 151   6                                                      tip_str="EnterToBegin...";
 152   6                                              }
 153   5                                              else
 154   5                                              {
 155   6                                                      tip_str="OutOfRange:g>0";
 156   6                                              }
 157   5                                              break;
 158   5                                      case 6://准备开始测量
 159   5                                              LcdClear();
 160   5                                              LcdShowStr(0,0,"Measuring...");
 161   5                                              return;
 162   5                                      }
 163   4                                      if(right_range)
 164   4                                      {
 165   5                                              ++state;
 166   5                                              LcdClear();
 167   5                                              LcdShowStr(0,0,tip_str);
 168   5                                              LcdSetCursor(0,1);
 169   5                                              if(state == 5)
 170   5                                              {
 171   6                                                      num = 980;
 172   6                                                      len = 3;
 173   6                                                      LcdShowStr(0,1,"980");
 174   6                                              }
 175   5                                              else
 176   5                                              {
 177   6                                                      num = 0;
 178   6                                                      len = 0;
 179   6                                              }
C51 COMPILER V9.02   MAIN                                                                  11/05/2020 23:56:57 PAGE 4   

 180   5                                      }
 181   4                                      else
 182   4                                      {
 183   5                                              LcdShowStr(0,0,tip_str);
 184   5                                              LcdSetCursor(len, 1);
 185   5                                      }
 186   4                                      break;
 187   4                              }
 188   3                      }
 189   2                      delay(2);
 190   2              }
 191   1      }
 192          
 193          void showTime()
 194          {
 195   1              u8 num_len,str[20];
 196   1              while(!MeasureFlag)
 197   1              {
 198   2                      num_len=uftoa(str,(50 * cnt50ms + (double)((TH0 << 8 | TL0) - (H50MS << 8 | L50MS)) * 0.001085)/1000,2);
 199   2                      str[num_len]='\0';
 200   2                      DISABLELED = 1; //禁用,以免操作影响液晶屏
 201   2                      LcdShowStr(0,1,"t:");
 202   2                      LcdShowStr(2,1,str);
 203   2                      LcdShowStr(2+num_len,1,"s");
 204   2                      P0=0xFF;
 205   2                      DISABLELED = 0;
 206   2                      delay(20);
 207   2              }
 208   1      }
 209          
 210          void showResult()
 211          {
 212   1              u8 num_len,str[20];
 213   1              double J_gm2;
 214   1              num_len=uftoa(str,Period,3);
 215   1              str[num_len]='\0';
 216   1              DISABLELED = 1;
 217   1              LcdClear();
 218   1              LcdShowStr(0,0,"T=");
 219   1              LcdShowStr(2,0,str);
 220   1              LcdShowStr(2+num_len,0,"ms");
 221   1              P0=0xFF;
 222   1              DISABLELED = 0;
 223   1              J_gm2=param_M_g*param_g*param_a_mm*param_b_mm*Period*Period/(12*PI*PI*10e9*param_H_mm);
 224   1              num_len=uftoa(str,Period,4);
 225   1              str[num_len]='\0';
 226   1              DISABLELED = 1;
 227   1              LcdShowStr(0,1,"J=");
 228   1              LcdShowStr(2,1,str);
 229   1              LcdShowStr(2+num_len,0,"g*m2");
 230   1              P0=0xFF;
 231   1              DISABLELED = 0;
 232   1      }
 233          /*正浮点数转字符串，返回字符串长度，不在末尾加'\0'*/
 234          u8 uftoa(char* dst, double num, u8 fs)
 235          {
 236   1              u8 i, chars_cnt, digits = 3;    //至少3位
 237   1              unsigned long factor = 10, temp; //因数多10倍，以便四舍五入
 238   1              for (i = 0; i != fs; ++i, factor *= 10);
 239   1              factor *= num;
 240   1              if (factor % 10 >= 5) //四舍五入
 241   1                      factor += 10;
C51 COMPILER V9.02   MAIN                                                                  11/05/2020 23:56:57 PAGE 5   

 242   1              factor /= 10;
 243   1              for (temp = factor; temp > 999; temp /= 10, ++digits);  //计算转为整数后的位数
 244   1              chars_cnt = digits + 1;
 245   1              for (i = 0; i != chars_cnt - 1; ++i)
 246   1              {
 247   2                      if (i == fs)
 248   2                              dst[digits--] = '.';
 249   2                      dst[digits--] = factor % 10 + '0';
 250   2                      factor /= 10;
 251   2              }
 252   1              return chars_cnt;
 253   1      }
 254          /*
 255          u8 utoa(char *dst, u16 num)
 256          {
 257                  u8 i, chars_cnt, digits = 1;
 258                  u16 temp;
 259                  for (temp = num; temp > 9; temp /= 10, ++digits);
 260                  chars_cnt=digits;
 261                  while (digits)
 262                  {
 263                          dst[--digits]=num%10+'0';
 264                          num /= 10;
 265                  }
 266                  return chars_cnt;
 267          }
 268          */
 269          void InterruptTime2() interrupt 3
 270          {
 271   1          static u8 i = 0, buzz_cnt = 0;
 272   1          TH1 = 0xFC;
 273   1          TL1 = 0x67;
 274   1          if(BuzzFlag)
 275   1              {
 276   2                      BUZZ=~BUZZ;
 277   2                      ++buzz_cnt;
 278   2                      if(buzz_cnt==100)
 279   2                      {
 280   3                              BuzzFlag=0;
 281   3                              buzz_cnt=0;
 282   3                      }
 283   2              }
 284   1              if(DISABLELED) return;
 285   1          P0 = 0xFF;
 286   1          ADDR2 = 0;
 287   1          ADDR1 = 0;
 288   1          switch (i)
 289   1          {
 290   2          case 0:
 291   2              ADDR0 = 0;
 292   2              break;
 293   2          case 1:
 294   2              ADDR0 = 1;
 295   2              break;
 296   2          }
 297   1          P0 = LedBuff[i++];
 298   1          if(i==2)
 299   1              i=0;
 300   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
C51 COMPILER V9.02   MAIN                                                                  11/05/2020 23:56:57 PAGE 6   

   CODE SIZE        =   1678    ----
   CONSTANT SIZE    =    219    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     27      76
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
