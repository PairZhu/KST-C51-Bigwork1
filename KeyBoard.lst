C51 COMPILER V9.02   KEYBOARD                                                              11/05/2020 22:18:26 PAGE 1   


C51 COMPILER V9.02, COMPILATION OF MODULE KEYBOARD
OBJECT MODULE PLACED IN KeyBoard.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE Hardware\KeyBoard.c BROWSE INCDIR(.\Hardware) DEBUG OBJECTEXTEND PRINT(.\Ke
                    -yBoard.lst) OBJECT(KeyBoard.obj)

line level    source

   1          #include "KeyBoard.h"
   2          
   3          u8 code KeyCodeMap[] = { //矩阵按键编号到标准键盘键码的映射表
   4                  0x00,                                   //空字符
   5                  0x31, 0x32, 0x33, 0x26 , //数字键 1、数字键 2、数字键 3、向上键
   6                  0x34, 0x35, 0x36, 0x25 , //数字键 4、数字键 5、数字键 6、向左键
   7                  0x37, 0x38, 0x39, 0x28 , //数字键 7、数字键 8、数字键 9、向下键
   8                  0x30, 0x1B, 0x0D, 0x27 , //数字键 0、ESC 键、 回车键、 向右键
   9                  /*
  10                  //以下为长按情况，将对应键值最高位置为1，即与0x80位或所得值
  11                  0xB1, 0xB2, 0xB3, 0xA6 , //长按：数字键 1、数字键 2、数字键 3、向上键
  12                  0xB4, 0xB5, 0xB6, 0xA5 , //长按：数字键 4、数字键 5、数字键 6、向左键
  13                  0xB7, 0xB8, 0xB9, 0xA8 , //长按：数字键 7、数字键 8、数字键 9、向下键
  14                  0xB0, 0x9B, 0x8D, 0xA7   //长按：数字键 0、ESC 键、 回车键、 向右键
  15                  */
  16          };
  17          
  18          static u8 getKey();
  19          u8 readKey()
  20          {
  21   1              static u8 cnt=1,lastkey=0;
  22   1              static bit long_press=0; //长按标志，若为1则表示键被长按，否则为短按或未按下
  23   1              if(getKey()==lastkey && lastkey!=0)
  24   1              {
  25   2                      ++cnt;
  26   2                      if(cnt==8)
  27   2                      {
  28   3                              return KeyCodeMap[lastkey];
  29   3                      }
  30   2                      if(cnt==75 && long_press)
  31   2                      {
  32   3                              cnt=1;
  33   3                      }
  34   2                      if(cnt==200) //按了400ms即是长按,则此后每150ms视为按下一次按钮
  35   2                      {
  36   3                              long_press=1;
  37   3                              cnt=1;
  38   3                              return KeyCodeMap[lastkey];
  39   3                      }
  40   2              }
  41   1              else
  42   1              {
  43   2                      long_press=0;
  44   2                      lastkey=getKey();
  45   2                      cnt=1;
  46   2              }
  47   1              return 0;
  48   1      }
  49          u8 getKey()
  50          {
  51   1              keyout1 = 0;
  52   1              keyout2 = 1;
  53   1              keyout3 = 1;
  54   1              keyout4 = 1;
C51 COMPILER V9.02   KEYBOARD                                                              11/05/2020 22:18:26 PAGE 2   

  55   1              if (keyin1 == 0)
  56   1                      return 1;
  57   1              if (keyin2 == 0)
  58   1                      return 2;
  59   1              if (keyin3 == 0)
  60   1                      return 3;
  61   1              if (keyin4 == 0)
  62   1                      return 4;
  63   1      
  64   1              keyout1 = 1;
  65   1              keyout2 = 0;
  66   1              keyout3 = 1;
  67   1              keyout4 = 1;
  68   1              if (keyin1 == 0)
  69   1                      return 5;
  70   1              if (keyin2 == 0)
  71   1                      return 6;
  72   1              if (keyin3 == 0)
  73   1                      return 7;
  74   1              if (keyin4 == 0)
  75   1                      return 8;
  76   1      
  77   1              keyout1 = 1;
  78   1              keyout2 = 1;
  79   1              keyout3 = 0;
  80   1              keyout4 = 1;
  81   1              if (keyin1 == 0)
  82   1                      return 9;
  83   1              if (keyin2 == 0)
  84   1                      return 10;
  85   1              if (keyin3 == 0)
  86   1                      return 11;
  87   1              if (keyin4 == 0)
  88   1                      return 12;
  89   1      
  90   1              keyout1 = 1;
  91   1              keyout2 = 1;
  92   1              keyout3 = 1;
  93   1              keyout4 = 0;
  94   1              if (keyin1 == 0)
  95   1                      return 13;
  96   1              if (keyin2 == 0)
  97   1                      return 14;
  98   1              if (keyin3 == 0)
  99   1                      return 15;
 100   1              if (keyin4 == 0)
 101   1                      return 16;
 102   1      
 103   1              return 0;
 104   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    194    ----
   CONSTANT SIZE    =     17    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      2    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
